<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æœƒè¨ˆå¸³å‹™ç³»çµ±</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    thead th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .status-ok { background-color: #c8e6c9; }
    .status-warning { background-color: #fff9c4; }
    .status-error { background-color: #ffcdd2; }
    .status-future { background-color: #bbdefb; }
    .off { background-color: #999999; }
    .disabled-link {
      color: #ccc;
      pointer-events: none;
      text-decoration: none;
      cursor: default;
    }
    .enable-link {
      color: #0000ee;
      text-decoration: underline;
      pointer-events: auto;
      cursor: pointer;
    }
    dialog.pdf-dialog {
      width: min(980px, 95vw);
      height: min(85vh, 900px);
      border: 1px solid #ccc;
      /* border-radius: 10px; */
      padding: 0;
      overflow: hidden;
    }
    .pdf-dialog::backdrop { background: rgba(0,0,0,.25); }

.pdfd-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px; border-bottom: 1px solid #eee; background: #fafafa;
  font-size: 14px; color: #444;
}
.pdfd-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.pdfd-actions { display: flex; gap: 8px; }
.pdfd-btn {
  font-size: 12px; padding: 6px 10px; border: 1px solid #bbb; background: #fff;
  border-radius: 6px; cursor: pointer;
}

.pdfd-body { width: 100%; height: calc(100% - 44px); }
#pdf-preview-frame { width: 100%; height: 100%; border: 0; background: #fff; }
  </style>
</head>
<body>
  <h1>æœƒè¨ˆå¸³å‹™ç³»çµ±</h1>
  <!-- ç¯©é¸æ§åˆ¶åˆ— -->
<div style="margin: 12px 0;">
  <label>
    <input type="checkbox" id="filter-due" />
    åƒ…é¡¯ç¤º
    <!-- <select id="expire-month" name="expire-month">
      <option value="2025/09">2025 å¹´ 09 æœˆ</option>
      <option value="2025/10">2025 å¹´ 10 æœˆ</option>
      <option value="2025/11">2025 å¹´ 11 æœˆ</option>
      <option value="2025/12">2025 å¹´ 12 æœˆ</option>
    </select> -->
    <select id="expire-month" name="expire-month"></select>
    éœ€å ±åƒ¹å…¬å¸
      <!-- æ›´æ–°è³‡æ–™æŒ‰éˆ• -->
      <button type="button" onclick="refresh_companies()" style="margin-left: 12px;">
        æ›´æ–°è³‡æ–™
      </button>
  </label>
  <label class="control">
      
</div>



  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>ä¸»ç´¢å¼•</th>
        <th>å…¬å¸åç¨±</th>
        <th>åˆ†åº—è³‡è¨Š</th>
        <th>ç·šä¸Š<br>æ”¶è²»</th>
        <th>æˆæ¬Š<br>é»æ•¸</th>
        <th>æ´»èº<br>åˆ†åº—</th>
        <th>æœ‰æ•ˆ<br>åˆ†åº—</th>
        <th>å¯ç”¨<br>æœˆæ•¸</th>
        <th>åˆ°æœŸæœˆä»½</th>
        <th>æ‡‰æ”¶å¸³æ¬¾</th>
        <!-- <th>å ±åƒ¹<br>éœ€æ±‚</th> -->
        <th>å«ç¨…æœªç¨…</th>
        <th>æ”¶è²»æœˆæ•¸</th>
        <th>æœˆç§ŸæŠ˜æ‰£(%off)</th>
        <th>è´ˆé€æœˆæ•¸</th>
        <th>ç”¢å‡ºå–®æ“š</th>
        <th>æª¢è¦–å–®æ“š</th>
      </tr>
    </thead>
    <tbody id="company-table-body">
      <!-- é€™è£¡ç”± JavaScript å‹•æ…‹å¡«å…… -->
    </tbody>
  </table>

  <!-- å‹•æ…‹æ’å…¥å°è©±æ¡†ç”¨çš„å®¹å™¨ -->
  <div id="dialogs-container"></div>

  <dialog id="pdf-preview-dialog" class="pdf-dialog">
    <div class="pdfd-header">
      <div id="pdf-preview-title" class="pdfd-title">å ±åƒ¹å–®é è¦½</div>
      <div class="pdfd-actions">
        <button id="pdf-open-newtab" class="pdfd-btn">æ–°åˆ†é é–‹å•Ÿ</button>
        <button id="pdf-close" class="pdfd-btn">é—œé–‰</button>
      </div>
    </div>
    <div class="pdfd-body">
      <iframe id="pdf-preview-frame" title="å ±åƒ¹å–® PDF é è¦½"></iframe>
    </div>
  </dialog>

    <script>

      function populateExpireMonthOptions(monthsAhead = 15) {
        const sel = document.getElementById('expire-month');
        if (!sel) return;

        // ä»¥ã€Œç•¶æœˆ 1 è™Ÿã€ç‚ºåŸºæº–
        const start = new Date();
        console.log(start)
        start.setDate(1);
        

        sel.innerHTML = '';
        for (let i = 0; i < monthsAhead; i++) {
          const d = new Date(start.getFullYear(), start.getMonth() + i, 1);
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const value = `${yyyy}/${mm}`;
          const label = `${yyyy} å¹´ ${mm} æœˆ`;

          const opt = new Option(label, value);
          opt.dataset.diffMonths = i;  // ğŸ‘ˆ ç›´æ¥å¡ diffMonths
          sel.add(opt);
        }

        // æ°¸é é è¨­ç•¶æœˆ
        const currentValue = `${start.getFullYear()}/${String(start.getMonth() + 1).padStart(2, '0')}`;
        sel.value = currentValue;
      }

      // å…ˆç”¢ç”Ÿæœˆä»½ â†’ å†è¼‰å…¥å…¬å¸è³‡æ–™
      populateExpireMonthOptions(15);

      async function refresh_companies(){
        const baseUrl = window.location.origin; // å–å¾—è‡ªå·±ç•¶å‰ç¶²é çš„ç¶²å€
        const res = await fetch(`${baseUrl}/api/refresh_companies`);
      }

        data=''
        async function loadCompanies() {
            try {
              const baseUrl = window.location.origin; // å–å¾—è‡ªå·±ç•¶å‰ç¶²é çš„ç¶²å€
              const res = await fetch(`${baseUrl}/api/companies`);
              if (!res.ok) throw new Error("HTTP " + res.status);
              companiesJson = await res.json();
              // console.log("å–å¾—çš„å…¬å¸è³‡æ–™ï¼š", companiesJson.data);

              // ç¯„ä¾‹ï¼šæŠŠæ¯å®¶å…¬å¸åç¨±å¡é€²è¡¨æ ¼
              const tbody = document.getElementById("company-table-body");
              tbody.innerHTML = ""; // æ¸…ç©º
              const dialogsContainer = document.getElementById("dialogs-container");
              dialogsContainer.innerHTML = ""; // æ¸…ç©ºæ‰€æœ‰å°è©±æ¡†

              // è®€å–ç›®å‰ UI ç‹€æ…‹
              const onlyDue = document.getElementById("filter-due").checked;
              const selectedMonth = document.getElementById("expire-month").value;
              const sel = document.getElementById("expire-month");
              const diffMonths = parseInt(sel.selectedOptions[0].dataset.diffMonths, 10);
              console.log(selectedMonth, diffMonths);

              // ç¯©é¸è³‡æ–™
              let list = companiesJson.data;
              if (onlyDue && selectedMonth) {
                // list = list.filter(c => c.due_month === selectedMonth);
                list = list.filter(c => (diffMonths - c.remain_months) % c.charge_months === 0 && diffMonths >= c.remain_months);
                // list = list.filter(c => c.online_pay === 1);
                
              }

              list.forEach((c, idx) => {
                  // console.log(c)
                  // åˆ¤æ–·é¡è‰² class
                  let statusClass = "";
                  if (c.active_count > c.license_count) {
                      statusClass = "status-error";     // æ´»èºæ•¸ > æˆæ¬Šæ•¸ â†’ ç•°å¸¸
                  } else if (c.active_count === c.license_count) {
                      statusClass = "status-warning";   // å‰›å¥½ç›¸ç­‰ â†’ è­¦å‘Š
                  } else {
                      statusClass = "status-ok";        // æˆæ¬Šæ•¸ > æ´»èºæ•¸ â†’ æ­£å¸¸
                  }

                  if (onlyDue){
                    c.due_month=selectedMonth
                    if (diffMonths > c.remain_months){
                      statusClass = "status-future";
                    }
                  }

                  const tr = document.createElement("tr");
                  // <td class="${c.quote_required === 0 ? 'off' : ''}">${c.quote_required}</td> // å ±åƒ¹éœ€æ±‚æ¬„ä½
                  tr.innerHTML = `
                  <td>${idx + 1}</td>
                  <td>${c.primary_key}</td>
                  <td>${c.company_name}</td>
                  <td>
                    <button onclick="document.getElementById('modal_${c.primary_key }').showModal()">æŸ¥çœ‹</button>
                  </td>
                  <td class="${c.online_pay === 0 ? 'off' : ''}">${c.online_pay}</td>
                  <td class="${statusClass}">${c.license_count}</td>
                  <td class="${statusClass}">${c.active_count}</td>
                  <td class="${statusClass}">${c.charge_count}</td>
                  <td class="${statusClass}">${c.remain_months}</td>
                  <td class="${statusClass}">${c.due_month}</td>
                  <td>${c.receivable}</td>
                  
                  

                  <td>
                      <input type="checkbox" class="input-tax"  checked >
                  </td>
                  <td>
                      <input type="range" class="input-months" min="1" max="12" step="1" value="${c.charge_months }"
                          style="width: 100px;"
                          oninput="this.nextElementSibling.innerText = this.value + ' å€‹æœˆ'">
                      <span>${ c.charge_months } å€‹æœˆ</span>
                  </td>
                  <td>
                      <input type="range" class="input-discount"  min="0" max="90" step="10" value="${ c.discount }" 
                          style="width: 100px;"
                          oninput="this.nextElementSibling.innerText = this.value + '%';">
                      <span>${ c.discount }%</span>
                  </td>
                  <td >
                      <input type="range" class="input-months" min="0" max="3" step="1" value="${c.bonus_months }"
                          style="width: 100px;"
                          oninput="this.nextElementSibling.innerText = this.value + ' å€‹æœˆ'">
                      <span>${c.bonus_months} å€‹æœˆ</span>
                  </td>
                  <td>
                    <button class="btn-micro" data-pk="${c.primary_key}" onclick="generateQuote(this)">ç”Ÿæˆ</button>
                  </td>
                  <td>
                    <button class="btn-micro preview-btn"
                      ${c.quote_path ? "" : "disabled"}
                      data-company="${(c.company_name || "").replace(/'/g, "\\'")}"
                      data-path="${(c.quote_path || "").replace(/'/g, "\\'")}"
                      onclick="previewQuoteInDialog(this.dataset.path, this.dataset.company)">
                      é è¦½
                    </button>
                  </td>
                  
                  `;
                  // <td><a href="${c.quote_path || '#'}" target="_blank">ä¸‹è¼‰</a></td>
                  // remainingMonths=Math.floor(c.license_count / (c.charge_count || 1))

                  tbody.appendChild(tr);


                  // === å°è©±æ¡†ï¼šä¾å…¬å¸åˆ†åº—è³‡è¨Šå‹•æ…‹å»ºç«‹ä¸¦åŠ å…¥å®¹å™¨ ===
                  const branches = Array.isArray(c.branches_info) ? c.branches_info : [];
                  const rowsHtml = branches.map(b => `
                    <tr>
                      <td>${b?.name ?? ""}</td>
                      <td>${(b?.is_main ? "ğŸ‘‘" : "ğŸ’µ")}</td>
                      <td><input type="checkbox" ${b?.is_active ? "checked" : ""}></td>
                      <td>${b?.sale_count ?? "null"}</td>
                      <td>${b?.ship_count ?? "null"}</td>
                      <td>${b?.repair_count ?? "null"}</td>
                    </tr>
                  `).join("");

                  const dialog = document.createElement("dialog");
                  dialog.id = `modal_${c.primary_key}`;
                  dialog.className = "branch-dialog"; // æœ‰ç„¡æ¨£å¼éƒ½ä¸å½±éŸ¿åŠŸèƒ½ï¼Œåƒ…ä¾›ç¾åŒ–ç”¨
                  dialog.innerHTML = `
                    <h3>${c.company_name} - åˆ†åº—è³‡è¨Š</h3>
                    <div class="dialog-body">
                      <table border="1" style="width:100%; border-collapse:collapse;">
                        <thead>
                          <tr>
                            <th>åˆ†åº—åç¨±</th>
                            <th>æ˜¯å¦ç¸½å€‰</th>
                            <th>æ˜¯å¦æ‰£é»</th>
                            <th>éŠ·è²¨å–®æ•¸</th>
                            <th>å‡ºè²¨å–®æ•¸</th>
                            <th>ç¶­ä¿®å–®æ•¸</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${rowsHtml}
                        </tbody>
                      </table>
                    </div>
                    <div class="dialog-actions" style="margin-top:12px; text-align:right;">
                      <button onclick="this.closest('dialog').close()">é—œé–‰</button>
                    </div>
                  `;

                  dialogsContainer.appendChild(dialog);
            });
            } catch (err) {
            console.error("è¼‰å…¥å¤±æ•—ï¼š", err);
            document.getElementById("company-table-body").innerHTML =
                `<tr><td colspan="10">è¼‰å…¥å¤±æ•—ï¼š${err.message}</td></tr>`;
            }
        }

        // è¼‰å…¥é é¢æ™‚åŸ·è¡Œ
        loadCompanies();
        // å‹¾é¸æˆ–ä¸‹æ‹‰æ”¹è®Šæ™‚ï¼Œé‡æ–°è¼‰å…¥
        document.getElementById("filter-due").addEventListener("change", loadCompanies);
        document.getElementById("expire-month").addEventListener("change", loadCompanies);

         // é–‹å•Ÿ PDF é è¦½ dialog
        function previewQuoteInDialog(url, companyName) {
          if (!url || url === "#") {
            alert("é€™ç­†è³‡æ–™æš«ç„¡å ±åƒ¹å–®æª”æ¡ˆå¯é è¦½ã€‚");
            return;
          }
          const dlg = document.getElementById("pdf-preview-dialog");
          const frame = document.getElementById("pdf-preview-frame");
          const title = document.getElementById("pdf-preview-title");
          const openBtn = document.getElementById("pdf-open-newtab");
          const closeBtn = document.getElementById("pdf-close");

          // è¨­å®šå…§å®¹
          frame.src = url;
          title.textContent = `${companyName} çš„å ±åƒ¹å–®`;
          openBtn.onclick = () => window.open(url, "_blank");
          closeBtn.onclick = () => dlg.close();

          // backdrop é»æ“Šé—œé–‰
          dlg.addEventListener("click", (e) => {
            const rect = dlg.getBoundingClientRect();
            const inDialog = (
              e.clientX >= rect.left && e.clientX <= rect.right &&
              e.clientY >= rect.top && e.clientY <= rect.bottom
            );
            if (!inDialog) dlg.close();
          }, { once: true });

          // é–‹å•Ÿ
          if (typeof dlg.showModal === "function") dlg.showModal();
          else dlg.show(); // fallback
        }

        async function generateQuote(btn) {
          const baseUrl = window.location.origin;

          // åŒåˆ—å…ƒç´ 
          const tr = btn.closest('tr');
          const pk = btn.dataset.pk;

          const taxIncluded = tr.querySelector('.input-tax')?.checked ? 1 : 0;
          const chargeMonths = Number(tr.querySelector('.input-months')?.value || 1);
          const discount = Number(tr.querySelector('.input-discount')?.value || 0);

            // å–å€¼
          const companyName = tr.children[2]?.textContent?.trim() || ''; // ç¬¬3æ¬„æ˜¯å…¬å¸åç¨±
          // const chargeMonths = Number(tr.querySelector('.input-months')?.value || 1);
          const priceIncludesTax = tr.querySelector('.input-tax')?.checked ? 'true' : 'false';
          const unitPrice = 2600*(100-discount)/100;
          const dueMonth = tr.children[9]?.textContent?.trim() || "";

          if (!companyName) return alert('æ‰¾ä¸åˆ°å…¬å¸åç¨±');
          // if (!unitPrice)   return alert('è«‹è¼¸å…¥å–®åƒ¹');

                  // UIï¼šæŒ‰éˆ•é€²åº¦ç‹€æ…‹
                  const oldLabel = btn.textContent;
                  btn.disabled = true;
                  btn.textContent = 'ç”Ÿæˆä¸­...';
        try {
            // çµ„ query string ä¾ä½ çš„ API è¦æ ¼
            const qs = new URLSearchParams({
              name: companyName,
              charge_months: String(chargeMonths),
              price_includes_tax: priceIncludesTax,
              unit_price: String(unitPrice),
              due_month: dueMonth
            });

            const url = `${baseUrl}/api/quote?${qs.toString()}`;
            console.log(url)
            const res = await fetch(url, { method: 'GET' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const json = await res.json();

            if (!json.ok) throw new Error(json.message || 'ç”Ÿæˆå¤±æ•—');
            var newPath = json.quote_path;
            
            // å¦‚æœè·¯å¾‘ä»¥ http: é–‹é ­ï¼Œæ›æˆ https:
            if (newPath.startsWith("http:")) {
                newPath = newPath.replace("http:", "https:");
            }
            console.log(newPath)
            if (!newPath) throw new Error('æœªå–å¾— quote_path');

            // æ›´æ–°æœ¬åˆ—çš„é è¦½æŒ‰éˆ•è·¯å¾‘
            const previewBtn = tr.querySelector('.preview-btn');
            if (previewBtn) {
              previewBtn.disabled = false;
              previewBtn.dataset.path = newPath;
              previewBtn.dataset.company = companyName;
            }

            // è‹¥ PDF å°è©±æ¡†å·²é–‹ä¸”æ˜¯åŒå…¬å¸ï¼Œç«‹å³åˆ·æ–° iframe
            const dlg = document.getElementById('pdf-preview-dialog');
            if (dlg?.open) {
              const title = document.getElementById('pdf-preview-title')?.textContent || '';
              if (title.includes(companyName)) {
                document.getElementById('pdf-preview-frame').src = newPath;
              }
            }

            btn.textContent = 'å®Œæˆ';
            setTimeout(() => { btn.textContent = oldLabel; btn.disabled = false; }, 800);

          } catch (err) {
            console.error(err);
            alert('ç”Ÿæˆå¤±æ•—ï¼š' + err.message);
            btn.textContent = oldLabel;
            btn.disabled = false;
          }
        }
    </script>
</body>
</html>
